プロジェクトの要件定義を以下のようにまとめさせていただきます：

# Healthleプロジェクト要件定義書

## 1. プロジェクト概要

Healthleは、医薬品のオンライン販売プラットフォームで、以下の3つの主要なアプリケーションで構成されています：

- ユーザー向けフロントエンド（frontend-user）
- 出店者向けフロントエンド（frontend-vendor）
- 管理者向けフロントエンド（frontend-admin）

## 2. 主要機能要件

### 2.1 ユーザー向け機能
- 医薬品の閲覧・購入
- 健康相談機能（AIによる回答システム）

```127:137:healthle/apps/frontend-user/src/app/consultation/[id]/page.tsx
                className="w-full flex justify-between items-center text-left mb-2"
              >
                <div className="flex items-center">
                  <Bot className="mr-2 h-5 w-5 text-[#4C9A84]" />
                  <h2 className="text-xl font-semibold text-[#4C9A84]">AI回答</h2>
                </div>
                {expandedSection === "aiResponse" ? "▲" : "▼"}
              </Button>
              {expandedSection === "aiResponse" && (
                <div className="mt-2 space-y-4 text-[#666666] whitespace-pre-wrap">{mockConsultation.aiResponse}</div>
              )}
```

- ユーザー情報管理
- 注文履歴の確認
- 相談履歴の管理

### 2.2 出店者向け機能
- 商品管理（登録・編集・削除）

```60:72:healthle/apps/frontend-vendor/app/products/new/page.tsx
                <Label htmlFor="category">医薬品種別</Label>
                <Select required>
                  <SelectTrigger id="category">
                    <SelectValue placeholder="種別を選択" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="first">第1類医薬品</SelectItem>
                    <SelectItem value="second">第2類医薬品</SelectItem>
                    <SelectItem value="third">第3類医薬品</SelectItem>
                    <SelectItem value="otc">一般用医薬品</SelectItem>
                  </SelectContent>
                </Select>
              </div>
```

- 注文管理
- 在庫管理
- 売上レポート確認

### 2.3 管理者向け機能
- 全商品の管理・監視
- ユーザー管理
- 出店者管理
- 薬剤師承認システム

```27:34:healthle/apps/frontend-admin/app/compliance/pharmacist-approvals/page.tsx
// Mock data for pharmacist approvals
const mockApprovals = [
  { id: 'APR001', orderId: 'ORD123', productName: '第1類医薬品A', userName: '山田太郎', orderDate: '2023-06-15 10:30', status: '承認待ち' },
  { id: 'APR002', orderId: 'ORD124', productName: '第1類医薬品B', userName: '佐藤花子', orderDate: '2023-06-15 11:45', status: '承認待ち' },
  { id: 'APR003', orderId: 'ORD125', productName: '第1類医薬品C', userName: '鈴木一郎', orderDate: '2023-06-15 14:20', status: '承認待ち' },
  { id: 'APR004', orderId: 'ORD126', productName: '第1類医薬品A', userName: '高橋美咲', orderDate: '2023-06-16 09:10', status: '承認待ち' },
  { id: 'APR005', orderId: 'ORD127', productName: '第1類医薬品D', userName: '田中健太', orderDate: '2023-06-16 13:55', status: '承認待ち' },
]
```


## 3. セキュリティ要件

### 3.1 個人情報保護

```13:16:healthle/apps/frontend-vendor/app/privacy/page.tsx
          <h2 className="text-xl font-semibold mb-4">1. 個人情報の定義</h2>
          <p className="mb-4">
            「個人情報」とは、個人情報保護法に定める「個人情報」を指します。すなわち、生存する個人に関する情報であって、当該情報に含まれる氏名、生年月日その他の記述等により特定の個人を識別することができるもの（他の情報と容易に照合することができ、それにより特定の個人を識別することができることとなるものを含みます。）を指します。

```


### 3.2 医薬品規制対応
- 医薬品分類に応じた販売制限

```93:104:healthle/apps/frontend-vendor/app/products/[id]/edit/page.tsx
                <Label htmlFor="category">医薬品種別</Label>
                <Select value={product.category} onValueChange={(value) => setProduct({ ...product, category: value })}>
                  <SelectTrigger id="category">
                    <SelectValue placeholder="種別を選択" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="first">第1類医薬品</SelectItem>
                    <SelectItem value="second">第2類医薬品</SelectItem>
                    <SelectItem value="third">第3類医薬品</SelectItem>
                    <SelectItem value="otc">一般用医薬品</SelectItem>
                  </SelectContent>
                </Select>
```


## 4. システム要件

### 4.1 技術スタック
- フロントエンド: Next.js
- UI: カスタムコンポーネント（Tailwind CSS使用）
- 認証システム: 要実装

### 4.2 パフォーマンス要件
- ページロード時間: 3秒以内
- モバイル対応（レスポンシブデザイン）

## 5. 運用要件

### 5.1 システムメンテナンス
- 定期的なアップデート対応
- セキュリティパッチの適用

### 5.2 カスタマーサポート
- 問い合わせ対応システム
- ヘルプデスク機能

## 6. コンプライアンス要件

### 6.1 法令遵守
- 薬機法への準拠
- 個人情報保護法への対応

```24:35:healthle/apps/frontend-user/src/app/privacy/page.tsx
                <h2 className="text-xl font-semibold mb-2 text-[#4C9A84]">1. 個人情報の収集</h2>
                <p className="text-[#666666]">
                  当社は、本サービスの提供にあたり、以下の個人情報を収集することがあります：
                </p>
                <ul className="list-disc pl-5 mt-2 text-[#666666]">
                  <li>氏名</li>
                  <li>メールアドレス</li>
                  <li>電話番号</li>
                  <li>住所</li>
                  <li>健康に関する情報</li>
                  <li>その他当社が定める入力フォームにユーザーが入力する情報</li>
                </ul>
```


### 6.2 取引規約

```42:57:healthle/apps/frontend-user/src/app/terms/page.tsx
                <h2 className="text-xl font-semibold mb-2 text-[#4C9A84]">4. 禁止事項</h2>
                <p className="text-[#666666]">
                  ユーザーは、本サービスの利用にあたり、以下の行為をしてはなりません。
                </p>
                <ul className="list-disc pl-5 mt-2 text-[#666666]">
                  <li>法令または公序良俗に違反する行為</li>
                  <li>犯罪行為に関連する行為</li>
                  <li>当社、本サービスの他のユーザー、または第三者のサーバーまたはネットワークの機能を破壊したり、妨害したりする行為</li>
                  <li>本サービスの運営を妨害するおそれのある行為</li>
                  <li>他のユーザーに関する個人情報等を収集または蓄積する行為</li>
                  <li>不正アクセスをし、またはこれを試みる行為</li>
                  <li>他のユーザーに成りすます行為</li>
                  <li>当社が許諾しない本サービス上での宣伝、広告、勧誘、または営業行為</li>
                  <li>当社のサービスに関連して、反社会的勢力に対して直接または間接に利益を供与する行為</li>
                  <li>その他、当社が不適切と判断する行為</li>
                </ul>
```


この要件定義は、現在のコードベースから抽出した情報に基づいています。実装の詳細やビジネスロジックについては、さらなる詳細化が必要かもしれません。


system:
  product_name: "Healthle"
  overview: >
    Healthleはオンライン健康相談とEC機能を統合したサービス。
    ユーザーはAIによる症状ヒアリングと商品の個別推薦を受け、
    必要なOTC医薬品を即購入可能。
    出店者が商品を登録・管理し、自社管理者が全体を監視・調整する。

requirements:
  user_frontend:
    objectives:
      - "LINEログインによるユーザー認証"
      - "健康相談（悩み入力→質問票生成→回答取得）"
      - "回答に基づく商品レコメンド表示"
      - "商品即時購入フロー（カートレス、Stripe決済）"
    features:
      authentication:
        provider: "LINE"
        initial_info: "住所・連絡先は初回購入時取得"
        timing:
          - "初回利用時はログイン不要で相談・回答表示まで可能"
          - "回答表示後、商品購入フローへ進む段階でLINEログインを促す"
          - "ログイン要求時、LINEログインによるメリット（迅速な購入、履歴管理、クーポン受取など）を明示"
      health_consultation:
        steps:
          - "ユーザー悩み入力（ログイン不要）"
          - "Dify質問票生成API呼び出し→JSON質問票表示"
          - "ユーザー回答取得→Dify回答API→LLM回答表示（ログイン不要）"
          - "回答表示後、Dify商品レコメンドAPI→商品IDリスト取得"
      product_display:
        - "商品IDを元にSupabase DBから情報取得"
        - "回答下に商品一覧表示（画像・価格・効能等）"
        - "購入する段階で初回ログイン促し"
      purchase_flow:
        - "在庫・価格チェック（Supabase）"
        - "Stripe決済"
        - "注文履歴参照機能"
    later_phases:
      - "第1類医薬品承認フロー"
      - "クーポン・ポイント機能"
      - "詳細な検索・比較機能"

  vendor_frontend:
    objectives:
      - "出店者が自社商品を登録・管理"
      - "在庫・価格・販売ステータス操作"
      - "医薬品特有の購入制限設定"
    features:
      authentication:
        method: "Email/Password or Google"
      product_management:
        - "商品登録（名前、画像、説明、医薬品種別、効能等）"
        - "在庫数編集"
        - "販売ステータス切り替え（販売中・予約・非表示）"
        - "価格変更（簡易）"
        - "購入上限数設定（第1類の場合、問診必須フラグ）"
      product_list_view:
        - "登録商品一覧表示"
        - "簡易検索（商品名）"
        - "個別編集画面への導線"
    later_phases:
      - "SEO向けキャッチコピー編集"
      - "複雑なバリエーション（色・サイズ）"
      - "PC/スマホ別デザイン編集"
      - "配送・納期詳細設定"

  admin_system:
    objectives:
      - "運営者が出店者・商品・注文・ユーザーを一元管理"
      - "トラブル対応やコンプライアンス確保"
    features:
      authentication:
        method: "Email/Password"
        roles: ["Admin", "Pharmacist", "Operator"]
      vendor_management:
        - "出店者一覧表示・編集"
        - "有効/停止切り替え"
      product_monitoring:
        - "商品一覧閲覧"
        - "在庫・価格・ステータス確認"
        - "緊急時商品非表示可能"
      order_management:
        - "注文一覧表示"
        - "注文ステータス変更（発送済み、キャンセル等）"
        - "第1類医薬品承認待ち一覧（後続で承認操作実装）"
      user_management:
        - "ユーザー一覧・購入履歴表示"
        - "不正ユーザー凍結"
      compliance_control:
        - "薬剤師承認履歴閲覧（MVPは閲覧のみ）"
        - "購入制限確認（手動）"
      logs_and_tracking:
        - "出店者操作ログ閲覧"
        - "管理者操作記録確認"
    later_phases:
      - "詳細な売上分析・レポート"
      - "高度なマーケティング機能管理"
      - "問い合わせ対応チャット機能"
      - "自動価格違反チェック機能"

development_plan:
  mvp_scope:
    - "ユーザー側：ログイン不要で相談・回答表示→購入時にLINEログイン促し"
    - "出店者側：商品基本登録・在庫価格変更・販売ステータス制御"
    - "管理者側：出店者・商品・注文・ユーザー基本管理、緊急対応"
  extensions:
    - "医薬品特有の高度な承認フロー、追加販促機能、詳細UIカスタマイズは後続"

画面一覧
トップページ（悩み入力画面）


機能：ユーザーが初回アクセス時に悩みテキストを直接入力
要素：テキスト入力ボックス、「相談開始」ボタン
流れ：「相談開始」で質問票画面へ遷移
補足：ログイン済みユーザーなら、ここからマイページや相談履歴画面へのリンクも表示可能
質問票画面


機能：Dify質問票生成APIから得た質問項目を表示し、ユーザー回答を取得
要素：質問リスト、回答入力フォーム、「回答送信」ボタン
流れ：「回答送信」で回答API呼び出し→回答表示＆商品レコメンド画面へ
回答表示＆商品レコメンド画面


機能：AI回答テキスト表示、レコメンド商品一覧表示
要素：AI回答、商品カード（画像、価格、簡易情報）、「購入する」ボタン
ログインなしでもここまでは可能
「購入する」押下時、未ログインならログイン誘導画面へ遷移
補足：ここでLINEログインすると、直前までの相談内容・回答がユーザーアカウントに紐付けて保存される
LINEログイン誘導画面


機能：購入・履歴保存のためにログインを促す
要素：LINEログインボタン、ログイン必要性・メリット説明（購入簡略化、相談履歴保存、クーポン受信等）
LINEログインコールバックページ（技術用）


機能：LINE OAuth成功後、ユーザーアカウントを確定し、相談履歴を保存、購入フローに戻る
自動で前画面（購入フローや回答表示画面）にリダイレクト
初回購入時ユーザー情報入力画面


機能：配送先住所・電話番号等を入力
要素：住所、電話番号など必須項目フォーム
「次へ」で決済画面へ
決済画面（チェックアウト画面）


機能：Stripe決済プロセス連携
要素：注文情報確認（商品名、価格）、「決済する」ボタン
「決済する」でStripe決済→成功で注文完了画面へ
注文完了画面


機能：決済完了通知
要素：注文詳細表示、「マイページへ」ボタンなど
マイページ（注文履歴・プロフィール編集への導線）


機能：ログインユーザーの購買履歴やプロフィール管理、相談履歴画面へのリンク
要素：
「注文履歴」リンク
「相談履歴」リンク
「プロフィール編集」リンク
相談履歴画面


機能：過去の相談内容とAI回答を閲覧
要素：
過去相談一覧（相談日時、悩み概要、AI回答要約）
各相談をクリックすると詳細表示モーダルまたは詳細ページへ遷移
初回利用時、回答後にログインすれば、直前の相談が保存されここで再確認可能
次回以降ログイン済みで訪れれば、すべての過去相談が閲覧可能
相談詳細表示（モーダルまたは詳細ページ）


機能：特定の相談記録の詳細表示
要素：悩みテキスト、質問票＆回答、AI回答テキスト、当時の推薦商品一覧（参考として表示するか検討）
商品購入リンクは過去データとして参考表示（在庫や価格が変わっている可能性は注意）
プロフィール編集画面


機能：住所・連絡先の変更
要素：フォーム入力、「保存」ボタン
利用規約・プライバシーポリシー画面


機能：規約・ポリシー表示
要素：テキスト記載、フッターリンクからアクセス
エラーページ / フォールバック画面


機能：API障害、決済失敗、在庫切れなどのエラー発生時に簡易的なエラーメッセージを表示
「トップへ戻る」ボタンなど
まとめ
更新後のエンドユーザー向けMVP画面一覧は以下のとおりです：
主な流れ用画面:


トップ(悩み入力)
質問票
回答表示＆商品レコメンド
LINEログイン誘導
LINEログインコールバック
初回購入時ユーザー情報入力
決済(チェックアウト)
注文完了
アカウント関連/履歴参照用画面:
 9. マイページ
 10. 相談履歴一覧
 11. 相談詳細表示
 12. プロフィール編集


その他:
 13. 利用規約・プライバシーポリシー
 14. エラーページ


これらにより、初回利用時にログイン無しで相談→回答表示→ログインで履歴保存が可能となり、以後はマイページから簡単に過去相談を見返せるユーザー体験が実現できる。
以下は、出店者（ベンダー）向けシステムで、MVP段階で想定される必要な画面を網羅的に洗い出した例です。
 MVPでは主に「商品管理（登録・編集・販売ステータス変更）」と「注文確認」がメインの機能となり、SEOや複雑な販促・デザイン編集機能は後続フェーズに回します。
画面一覧（出店者向け）
ログイン画面


機能：Email/Password（もしくはGoogleログイン）で出店者がログイン
要素：メールアドレス入力欄、パスワード入力欄、ログインボタン、（必要であれば）パスワードリセットリンク
初回利用時ここから開始
ダッシュボード画面（簡易）


機能：ログイン後のトップ画面として、商品管理・注文確認・アカウント設定等へのナビゲーション
要素：
「商品一覧へ」ボタン
「注文一覧へ」ボタン
「アカウント設定」ボタン
簡易的な売上サマリーやお知らせ欄を設けることも可能（MVPでは必須ではない）
商品一覧画面


機能：出店者が登録している商品の一覧を表示
要素：
商品名、価格、在庫数、販売ステータス一覧
「編集」ボタン（商品編集画面へ）
「新規商品登録」ボタン
簡易検索（商品名でフィルタ）
商品新規登録画面


機能：新しい商品を登録するフォーム
要素：
商品名入力欄、商品画像アップロード、商品説明、医薬品種別・効能・用法用量等の基本情報
在庫数、販売ステータス（販売中、予約、非表示）、価格設定
第1類医薬品の場合、問診必須フラグや購入上限数などの入力欄
「登録」ボタン
商品編集画面


機能：既存商品の情報を編集
要素：
商品名、画像、説明の変更欄
在庫数、価格、販売ステータス（販売中・非表示・予約）変更欄
医薬品属性・購入制限（上限数、問診フラグ）設定欄
「保存」ボタン
注文一覧画面（オプションだがMVP段階で商品の売れ行きや出荷対応が必要な場合は必須）


機能：ユーザーが購入した注文を確認
要素：
注文ID、購入日時、購入商品、数量、ステータス（未出荷、出荷済み等）
「詳細」ボタン（注文詳細画面へ）
出店者が配送対応を行うためには最低限必要
注文詳細画面（必要に応じて）


機能：特定注文の詳細情報表示
要素：
ユーザー配送先、注文商品リスト、注文ステータス変更ボタン（出荷済みにする等）
メモ欄（必要なら）
アカウント設定画面


機能：出店者プロフィールや連絡先メールアドレスの変更
要素：
出店者名、担当者名、メールアドレス、パスワード変更フォーム
「保存」ボタン
利用規約・プライバシーポリシー画面


機能：出店者向け利用規約やプライバシーポリシーの表示
要素：テキスト掲載、フッターからアクセス可能
エラーページ / フォールバック画面


機能：API障害や権限エラー発生時に簡易なエラーメッセージ表示
「ダッシュボードへ戻る」等のリンク
（必要に応じて）パスワードリセット画面
機能：ログインできない出店者がメールでパスワードリセットリンクを受け取り、新パスワード設定
要素：メールアドレス入力フォーム、「リセットメール送信」ボタン、確認画面
まとめ
MVPにおける出店者向け画面は以下が中心：
認証関連：ログイン画面（＋パスワードリセット画面オプション）
基本操作：ダッシュボード（ナビゲーション）、商品一覧、商品登録、商品編集
注文対応：注文一覧、注文詳細（在庫販売のみの段階では後回し可能だが、基本的には出店者が注文を認識・管理できる画面が必要）
アカウント管理：アカウント設定画面で基本情報変更
規約表示・エラー対応：利用規約・プライバシーポリシー、エラーページ
これらにより、出店者は商品をアップロード・メンテナンスし、購入された場合に注文情報を確認できる最低限の運営環境が整います。
以下は、MVP段階で想定される自社管理システム（管理者向けバックオフィスUI）の画面一覧です。
 MVPでは、運営者が出店者、商品、注文、ユーザー状況を一元的に確認・管理でき、最小限のコンプライアンス対応やトラブルシューティングが可能なことを目指します。
画面一覧（自社管理システム）
管理者ログイン画面


機能：Admin, Pharmacist, Operatorなど内部アカウント用ログイン
要素：メールアドレス、パスワード入力欄、ログインボタン
初回利用やパスワードリセット用画面（後続対応可）を用意する場合もある
ダッシュボード（簡易）画面


機能：ログイン後の起点となる画面
要素：
出店者管理、商品管理、注文管理、ユーザー管理へのリンク
シンプルなサマリー（登録商品数、注文数など）
詳細な分析グラフや高度なレポートは後続で
出店者管理関連画面:


出店者一覧画面


機能：登録出店者の一覧表示（ベンダー名、メール、ステータス）
要素：検索ボックス（ベンダー名）、ステータスフィルタ、一覧テーブル
「詳細」ボタンで出店者詳細画面へ
出店者詳細画面


機能：個別出店者の情報確認・編集
要素：出店者名、担当者情報、メール、ステータス（有効/停止）変更ボタン
メモ欄（内部向け）やログ参照リンク（後続拡張）
「保存」ボタンで変更反映
新規出店者登録画面（必要に応じて）


機能：新規出店者アカウント作成
要素：出店者名、メール、初期パスワード設定、ロール設定（後続対応）
「登録」ボタン
商品管理関連画面:


商品一覧画面


機能：全商品を横断的に一覧表示（商品名、出店者名、在庫、価格、ステータス）
要素：検索ボックス（商品名）、フィルタ（出店者、ジャンル）、商品テーブル
緊急非表示・販売停止など、管理者権限で強制変更ボタン
商品詳細（閲覧用）画面


機能：商品個別情報参照（出店者側で編集するため、管理者側は原則閲覧のみ）
要素：商品名、画像、説明、価格、在庫、ステータス、医薬品属性、購入制限設定
「販売停止」ボタン等、緊急操作可能な場合
管理者側は基本的には編集しない前提（MVPでは閲覧＋緊急対応程度）
注文管理関連画面:


注文一覧画面


機能：全注文を一覧表示（注文ID、ユーザーID、購入商品、ステータス、日付）
要素：検索（注文ID、ユーザーID）、ステータスフィルタ、テーブル表示
「詳細」ボタンで注文詳細画面へ
注文詳細画面


機能：特定注文の詳細確認
要素：ユーザー情報（配送先）、購入商品リスト、金額、ステータス
ステータス変更ボタン（発送済み、キャンセル等）
法的承認必要な商品がある場合、その承認状況を確認（薬剤師承認は後続で操作実装）
ユーザー管理関連画面:


ユーザー一覧画面


機能：エンドユーザーアカウント一覧表示
要素：ユーザーID、LINEログイン情報、検索（ユーザーID、名前）
「詳細」ボタンでユーザー詳細画面へ
ユーザー詳細画面


機能：個別ユーザー情報参照
要素：基本情報（住所、連絡先）、購入履歴、相談履歴リンク
不正ユーザーの場合、利用停止ボタン
購入・相談履歴はリンククリックで別画面（後続対応か、この画面内で表示）
（オプション）ユーザー相談履歴表示画面：


機能：特定ユーザーの相談履歴を管理者が参照し、不正行為やトラブル対応
要素：相談日付、悩み要約、AI回答
MVPでは不要かもしれませんが、問題ユーザー対応で必要になる可能性あり
コンプライアンス・薬剤師関連画面（MVPでは閲覧中心、操作は後続）:


薬剤師承認待ち一覧画面（オプション）
機能：第1類医薬品購入時の承認待ちリストを表示（後続対応）
MVPでは表示のみ、承認操作は後続
購入制限設定確認画面（オプション）
機能：商品ごとの購入制限ルール一覧
MVPでは商品詳細で確認する程度で、この画面は後続対応
ログ・アクティビティ追跡関連画面（簡易版）:


操作ログ一覧画面
機能：出店者や管理者がいつ、何を変更したか記録を一覧表示（MVPでは簡易ログ）
要素：操作日時、操作ユーザー、操作対象（商品ID、出店者ID等）、操作内容
アカウント管理（管理者自身）画面:


機能：管理者自身のパスワード変更やメール変更
要素：メール、パスワード変更フォーム、「保存」ボタン
利用規約・プライバシーポリシー画面:


機能：自社管理システム用規約表示（MVPでは単純に表示用）
エラーページ / フォールバック画面:


機能：API障害、権限エラー時のエラーメッセージ表示
「ダッシュボードへ戻る」リンク
まとめ
MVPの自社管理システム画面は以下が中心：
認証関連：管理者ログイン
ダッシュボード：各管理機能へのナビゲーション
出店者管理：出店者一覧、詳細、（必要なら新規登録）
商品管理：商品一覧、商品詳細（閲覧＋緊急停止）
注文管理：注文一覧、注文詳細（ステータス変更）
ユーザー管理：ユーザー一覧、ユーザー詳細（利用停止措置）
ログ確認：操作ログ一覧
アカウント管理：管理者自身の情報変更
規約表示・エラー対応：利用規約ページ、エラーページ
これらにより、運営者はサービス全体をコントロールするための基本的な機能を行使でき、MVP段階で最低限の運用とコンプライアンス対応が可能になります。

